<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AREA: fast-safe-stringify</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">AREA
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">fast-safe-stringify</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md30091"></a> Safe and fast serialization alternative to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify</a>.</p>
<p>Gracefully handles circular structures instead of throwing in most cases. It could return an error string if the circular object is too complex to analyze, e.g. in case there are proxies involved.</p>
<p>Provides a deterministic ("stable") version as well that will also gracefully handle circular structures. See the example below for further information.</p>
<h1><a class="anchor" id="autotoc_md30092"></a>
Usage</h1>
<p>The same as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify</a>.</p>
<p><code>stringify(value[, replacer[, space[, options]]])</code></p>
<div class="fragment"><div class="line">const safeStringify = require(&#39;fast-safe-stringify&#39;)</div>
<div class="line">const o = { a: 1 }</div>
<div class="line">o.o = o</div>
<div class="line"> </div>
<div class="line">console.log(safeStringify(o))</div>
<div class="line">// &#39;{&quot;a&quot;:1,&quot;o&quot;:&quot;[Circular]&quot;}&#39;</div>
<div class="line">console.log(JSON.stringify(o))</div>
<div class="line">// TypeError: Converting circular structure to JSON</div>
<div class="line"> </div>
<div class="line">function replacer(key, value) {</div>
<div class="line">  console.log(&#39;Key:&#39;, JSON.stringify(key), &#39;Value:&#39;, JSON.stringify(value))</div>
<div class="line">  // Remove the circular structure</div>
<div class="line">  if (value === &#39;[Circular]&#39;) {</div>
<div class="line">    return</div>
<div class="line">  }</div>
<div class="line">  return value</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// those are also defaults limits when no options object is passed into safeStringify</div>
<div class="line">// configure it to lower the limit.</div>
<div class="line">const options = {</div>
<div class="line">  depthLimit: Number.MAX_SAFE_INTEGER,</div>
<div class="line">  edgesLimit: Number.MAX_SAFE_INTEGER</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">const serialized = safeStringify(o, replacer, 2, options)</div>
<div class="line">// Key: &quot;&quot; Value: {&quot;a&quot;:1,&quot;o&quot;:&quot;[Circular]&quot;}</div>
<div class="line">// Key: &quot;a&quot; Value: 1</div>
<div class="line">// Key: &quot;o&quot; Value: &quot;[Circular]&quot;</div>
<div class="line">console.log(serialized)</div>
<div class="line">// {</div>
<div class="line">//  &quot;a&quot;: 1</div>
<div class="line">// }</div>
</div><!-- fragment --><p>Using the deterministic version also works the same:</p>
<div class="fragment"><div class="line">const safeStringify = require(&#39;fast-safe-stringify&#39;)</div>
<div class="line">const o = { b: 1, a: 0 }</div>
<div class="line">o.o = o</div>
<div class="line"> </div>
<div class="line">console.log(safeStringify(o))</div>
<div class="line">// &#39;{&quot;b&quot;:1,&quot;a&quot;:0,&quot;o&quot;:&quot;[Circular]&quot;}&#39;</div>
<div class="line">console.log(safeStringify.stableStringify(o))</div>
<div class="line">// &#39;{&quot;a&quot;:0,&quot;b&quot;:1,&quot;o&quot;:&quot;[Circular]&quot;}&#39;</div>
<div class="line">console.log(JSON.stringify(o))</div>
<div class="line">// TypeError: Converting circular structure to JSON</div>
</div><!-- fragment --><p>A faster and side-effect free implementation is available in the [safe-stable-stringify][] module. However it is still considered experimental due to a new and more complex implementation.</p>
<h2><a class="anchor" id="autotoc_md30093"></a>
Replace strings constants</h2>
<ul>
<li><code>[Circular]</code> - when same reference is found</li>
<li><code>[...]</code> - when some limit from options object is reached</li>
</ul>
<h1><a class="anchor" id="autotoc_md30094"></a>
Differences to JSON.stringify</h1>
<p>In general the behavior is identical to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify</a>. The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#The%20replacer%20parameter"><code>replacer</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#The%20space%20argument"><code>space</code></a> options are also available.</p>
<p>A few exceptions exist to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify</a> while using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#toJSON()_behavior"><code>toJSON</code></a> or <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#The%20replacer%20parameter"><code>replacer</code></a>:</p>
<h2><a class="anchor" id="autotoc_md30095"></a>
Regular safe stringify</h2>
<ul>
<li>Manipulating a circular structure of the passed in value in a <code>toJSON</code> or the <code>replacer</code> is not possible! It is possible for any other value and property.</li>
<li>In case a circular structure is detected and the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#The%20replacer%20parameter"><code>replacer</code></a> is used it will receive the string <code>[Circular]</code> as the argument instead of the circular object itself.</li>
</ul>
<h2><a class="anchor" id="autotoc_md30096"></a>
Deterministic ("stable") safe stringify</h2>
<ul>
<li>Manipulating the input object either in a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#toJSON()_behavior"><code>toJSON</code></a> or the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#The%20replacer%20parameter"><code>replacer</code></a> function will not have any effect on the output. The output entirely relies on the shape the input value had at the point passed to the stringify function!</li>
<li>In case a circular structure is detected and the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#The%20replacer%20parameter"><code>replacer</code></a> is used it will receive the string <code>[Circular]</code> as the argument instead of the circular object itself.</li>
</ul>
<p>A side effect free variation without these limitations can be found as well (<a href="https://github.com/BridgeAR/safe-stable-stringify"><code>safe-stable-stringify</code></a>). It is also faster than the current implementation. It is still considered experimental due to a new and more complex implementation.</p>
<h1><a class="anchor" id="autotoc_md30097"></a>
Benchmarks</h1>
<p>Although not JSON, the Node.js <code>util.inspect</code> method can be used for similar purposes (e.g. logging) and also handles circular references.</p>
<p>Here we compare <code>fast-safe-stringify</code> with some alternatives: (Lenovo T450s with a i7-5600U CPU using Node.js 8.9.4)</p>
<div class="fragment"><div class="line">fast-safe-stringify:   simple object x 1,121,497 ops/sec ±0.75% (97 runs sampled)</div>
<div class="line">fast-safe-stringify:   circular      x 560,126 ops/sec ±0.64% (96 runs sampled)</div>
<div class="line">fast-safe-stringify:   deep          x 32,472 ops/sec ±0.57% (95 runs sampled)</div>
<div class="line">fast-safe-stringify:   deep circular x 32,513 ops/sec ±0.80% (92 runs sampled)</div>
<div class="line"> </div>
<div class="line">util.inspect:          simple object x 272,837 ops/sec ±1.48% (90 runs sampled)</div>
<div class="line">util.inspect:          circular      x 116,896 ops/sec ±1.19% (95 runs sampled)</div>
<div class="line">util.inspect:          deep          x 19,382 ops/sec ±0.66% (92 runs sampled)</div>
<div class="line">util.inspect:          deep circular x 18,717 ops/sec ±0.63% (96 runs sampled)</div>
<div class="line"> </div>
<div class="line">json-stringify-safe:   simple object x 233,621 ops/sec ±0.97% (94 runs sampled)</div>
<div class="line">json-stringify-safe:   circular      x 110,409 ops/sec ±1.85% (95 runs sampled)</div>
<div class="line">json-stringify-safe:   deep          x 8,705 ops/sec ±0.87% (96 runs sampled)</div>
<div class="line">json-stringify-safe:   deep circular x 8,336 ops/sec ±2.20% (93 runs sampled)</div>
</div><!-- fragment --><p>For stable stringify comparisons, see the performance benchmarks in the <a href="https://github.com/BridgeAR/safe-stable-stringify"><code>safe-stable-stringify</code></a> readme.</p>
<h1><a class="anchor" id="autotoc_md30098"></a>
Protip</h1>
<p>Whether <code>fast-safe-stringify</code> or alternatives are used: if the use case consists of deeply nested objects without circular references the following pattern will give best results. Shallow or one level nested objects on the other hand will slow down with it. It is entirely dependant on the use case.</p>
<div class="fragment"><div class="line">const stringify = require(&#39;fast-safe-stringify&#39;)</div>
<div class="line"> </div>
<div class="line">function tryJSONStringify (obj) {</div>
<div class="line">  try { return JSON.stringify(obj) } catch (_) {}</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">const serializedString = tryJSONStringify(deep) || stringify(deep)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md30099"></a>
Acknowledgements</h1>
<p>Sponsored by <a href="http://nearform.com">nearForm</a></p>
<h1><a class="anchor" id="autotoc_md30100"></a>
License</h1>
<p>MIT </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
